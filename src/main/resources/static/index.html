<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chess Game</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap">
</head>
<body>
<div class="container">
    <header>
        <h1>Chess Game</h1>
    </header>

    <div class="game-container">
        <div class="game-sidebar">
            <div class="game-info">
                <div id="status" class="status-indicator">Current Turn: White</div>
                <button id="new-game-btn" class="btn primary-btn">New Game</button>
            </div>

            <div class="move-history">
                <h3>Move History</h3>
                <div id="moves-list" class="moves-list"></div>
            </div>

            <div class="captured-pieces">
                <div class="captured-white">
                    <h4>Captured White Pieces</h4>
                    <div id="white-captured" class="pieces-container"></div>
                </div>
                <div class="captured-black">
                    <h4>Captured Black Pieces</h4>
                    <div id="black-captured" class="pieces-container"></div>
                </div>
            </div>
        </div>

        <div class="chessboard-container">
            <div class="board-wrapper">
                <div class="coordinates">
                    <div class="ranks">
                        <span>8</span><span>7</span><span>6</span><span>5</span>
                        <span>4</span><span>3</span><span>2</span><span>1</span>
                    </div>
                    <div id="chessboard" class="chessboard"></div>
                    <div class="files">
                        <span>a</span><span>b</span><span>c</span><span>d</span>
                        <span>e</span><span>f</span><span>g</span><span>h</span>
                    </div>
                </div>
            </div>

            <div id="promotion-modal" class="modal">
                <div class="modal-overlay"></div>
                <div class="modal-content">
                    <h3>Promote Pawn</h3>
                    <div class="promotion-options">
                        <div class="promotion-piece" data-piece="QUEEN">
                            <img src="/w-queen.png" alt="Queen" id="promotion-queen">
                        </div>
                        <div class="promotion-piece" data-piece="ROOK">
                            <img src="/w-rook.png" alt="Rook" id="promotion-rook">
                        </div>
                        <div class="promotion-piece" data-piece="BISHOP">
                            <img src="/w-bishop.png" alt="Bishop" id="promotion-bishop">
                        </div>
                        <div class="promotion-piece" data-piece="KNIGHT">
                            <img src="/w-knight.png" alt="Knight" id="promotion-knight">
                        </div>
                    </div>
                </div>
            </div>

            <div id="game-result" class="game-result hidden"></div>
        </div>
    </div>
</div>

<script>
    // Check if the new game button exists
    window.addEventListener('DOMContentLoaded', () => {
        const newGameBtn = document.getElementById('new-game-btn');
        if (newGameBtn) {

            // Handle button click
            newGameBtn.addEventListener('click', () => {
                // Visual feedback that the button was clicked
                newGameBtn.classList.add('loading');
                newGameBtn.innerHTML = '<span class="spinner"></span> Starting...';

                // Clear existing moves and captured pieces
                document.getElementById('moves-list').innerHTML = '';
                document.getElementById('white-captured').innerHTML = '';
                document.getElementById('black-captured').innerHTML = '';

                // Fix for potential CORS issues - add absolute URL
                const baseUrl = window.location.origin;

                // Check if API endpoints are accessible
                fetch(`${baseUrl}/api/v1/chess/new-game`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    credentials: 'same-origin'
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        return fetch(`${baseUrl}/api/v1/chess/board`, {
                            headers: {
                                'Accept': 'application/json'
                            },
                            credentials: 'same-origin'
                        });
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(boardData => {
                        // Hide game result if visible
                        document.getElementById('game-result').classList.add('hidden');

                        return fetch(`${baseUrl}/api/v1/chess/status`, {
                            headers: {
                                'Accept': 'application/json'
                            },
                            credentials: 'same-origin'
                        });
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(statusData => {
                        newGameBtn.classList.remove('loading');
                        newGameBtn.textContent = "New Game";

                        // Update status with animation
                        const statusElement = document.getElementById('status');
                        statusElement.classList.add('status-update');
                        statusElement.textContent = `Current Turn: ${statusData.currentPlayer || 'White'}`;
                        setTimeout(() => {
                            statusElement.classList.remove('status-update');
                        }, 500);
                    })
                    .catch(error => {
                        newGameBtn.classList.remove('loading');
                        newGameBtn.textContent = "New Game";

                        // Show error notification
                        const gameResult = document.getElementById('game-result');
                        gameResult.textContent = `Error: ${error.message}`;
                        gameResult.classList.remove('hidden');
                        gameResult.classList.add('error');
                    });
            });

            // Make sure the button is visible and enabled
            newGameBtn.style.display = 'inline-block';
            newGameBtn.disabled = false;
        }
    });

    // Listen for move events from the chess.js script
    document.addEventListener('chess-move', function(e) {
        if (e.detail && e.detail.notation) {
            // If a piece was captured
            if (e.detail.capturedPiece) {
                addCapturedPiece(e.detail.capturedPiece, e.detail.capturedColor);
            }
        }
    });
</script>
<script src="/js/chess.js"></script>
</body>
</html>
