<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chess Game</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap">
</head>
<body>
<div class="container">
    <header>
        <h1>Chess Game</h1>
    </header>

    <div class="game-container">
        <div class="game-sidebar">
            <div class="game-info">
                <div id="status" class="status-indicator">Current Turn: White</div>
                <button id="new-game-btn" class="btn primary-btn">New Game</button>
            </div>

            <div class="move-history">
                <h3>Move History</h3>
                <div id="moves-list" class="moves-list"></div>
            </div>

            <div class="captured-pieces">
                <div class="captured-white">
                    <h4>Captured White Pieces</h4>
                    <div id="white-captured" class="pieces-container"></div>
                </div>
                <div class="captured-black">
                    <h4>Captured Black Pieces</h4>
                    <div id="black-captured" class="pieces-container"></div>
                </div>
            </div>
        </div>

        <div class="chessboard-container">
            <div class="board-wrapper">
                <div class="coordinates">
                    <div class="ranks">
                        <span>8</span><span>7</span><span>6</span><span>5</span>
                        <span>4</span><span>3</span><span>2</span><span>1</span>
                    </div>
                    <div id="chessboard" class="chessboard"></div>
                    <div class="files">
                        <span>a</span><span>b</span><span>c</span><span>d</span>
                        <span>e</span><span>f</span><span>g</span><span>h</span>
                    </div>
                </div>
            </div>

            <div id="promotion-modal" class="modal">
                <div class="modal-overlay"></div>
                <div class="modal-content">
                    <h3>Promote Pawn</h3>
                    <div class="promotion-options">
                        <div class="promotion-piece" data-piece="QUEEN">
                            <img src="/w-queen.png" alt="Queen" id="promotion-queen">
                        </div>
                        <div class="promotion-piece" data-piece="ROOK">
                            <img src="/w-rook.png" alt="Rook" id="promotion-rook">
                        </div>
                        <div class="promotion-piece" data-piece="BISHOP">
                            <img src="/w-bishop.png" alt="Bishop" id="promotion-bishop">
                        </div>
                        <div class="promotion-piece" data-piece="KNIGHT">
                            <img src="/w-knight.png" alt="Knight" id="promotion-knight">
                        </div>
                    </div>
                </div>
            </div>

            <div id="game-result" class="game-result hidden"></div>
        </div>
    </div>

    <!-- Debug console for troubleshooting -->
    <div class="debug-panel">
        <div class="debug-header">
            <h3>Debug Console</h3>
            <button id="toggle-debug" class="btn toggle-btn">Hide</button>
        </div>
        <div id="debug-output" class="debug-output"></div>
    </div>
</div>

<script>
    // Add a debug function
    function debugLog(message) {
        const debugOutput = document.getElementById('debug-output');
        if (debugOutput) {
            const logEntry = document.createElement('div');
            logEntry.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            debugOutput.appendChild(logEntry);
            debugOutput.scrollTop = debugOutput.scrollHeight;
            console.log(message);
        }
    }

    // Toggle debug console
    document.getElementById('toggle-debug').addEventListener('click', function() {
        const debugOutput = document.getElementById('debug-output');
        const toggleBtn = document.getElementById('toggle-debug');

        if (debugOutput.style.display === 'none') {
            debugOutput.style.display = 'block';
            toggleBtn.textContent = 'Hide';
        } else {
            debugOutput.style.display = 'none';
            toggleBtn.textContent = 'Show';
        }
    });

    debugLog("Page loaded");

    // Function to add a move to the history
    function addMoveToHistory(notation) {
        const movesList = document.getElementById('moves-list');
        if (!movesList) {
            debugLog("Error: moves-list element not found");
            return;
        }
        const moveItem = document.createElement('div');
        moveItem.className = 'move-item';
        moveItem.textContent = notation;
        movesList.appendChild(moveItem);
        movesList.scrollTop = movesList.scrollHeight;
        debugLog(`Move added to history: ${notation}`);
    }

    // Function to add a captured piece
    function addCapturedPiece(piece, color) {
        const containerId = `${color.toLowerCase()}-captured`;
        const container = document.getElementById(containerId);
        if (!container) {
            debugLog(`Error: ${containerId} element not found`);
            return;
        }

        // Convert piece type to lowercase for consistency
        const pieceType = piece.toLowerCase();
        const pieceColor = color.toLowerCase();
        const pieceKey = `${pieceColor}-${pieceType}`;

        // Check if this piece type already exists in captured pieces
        const existingPieceGroup = container.querySelector(`.piece-group[data-piece="${pieceKey}"]`);

        if (existingPieceGroup) {
            // Increment counter if piece already exists
            const counter = existingPieceGroup.querySelector('.piece-counter');
            if (counter) {
                const count = parseInt(counter.textContent) + 1;
                counter.textContent = count;
                debugLog(`Incremented captured ${pieceColor} ${pieceType} count to ${count}`);
            }
        } else {
            // Create new piece group with image and counter
            const pieceGroup = document.createElement('div');
            pieceGroup.className = 'piece-group';
            pieceGroup.dataset.piece = pieceKey;

            const pieceElement = document.createElement('img');
            pieceElement.src = `/${color[0]}-${pieceType}.png`;
            pieceElement.alt = pieceType;
            pieceElement.className = 'captured-piece';

            const counterElement = document.createElement('span');
            counterElement.className = 'piece-counter';
            counterElement.textContent = '1';

            pieceGroup.appendChild(pieceElement);
            pieceGroup.appendChild(counterElement);
            container.appendChild(pieceGroup);

            debugLog(`Added new captured piece: ${pieceType} (${pieceColor})`);
        }
    }

    // Check if the new game button exists
    window.addEventListener('DOMContentLoaded', () => {
        debugLog("DOM fully loaded");

        // No more testing code here

        const newGameBtn = document.getElementById('new-game-btn');
        if (newGameBtn) {
            debugLog("New Game button found");

            // Handle button click
            newGameBtn.addEventListener('click', () => {
                debugLog("New Game button clicked");
                // Visual feedback that the button was clicked
                newGameBtn.classList.add('loading');
                newGameBtn.innerHTML = '<span class="spinner"></span> Starting...';

                // Clear existing moves and captured pieces
                document.getElementById('moves-list').innerHTML = '';
                document.getElementById('white-captured').innerHTML = '';
                document.getElementById('black-captured').innerHTML = '';

                // Fix for potential CORS issues - add absolute URL
                const baseUrl = window.location.origin;
                debugLog(`Base URL: ${baseUrl}`);

                // Check if API endpoints are accessible
                debugLog("Sending new game request...");
                fetch(`${baseUrl}/api/v1/chess/new-game`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    credentials: 'same-origin'
                })
                    .then(response => {
                        debugLog(`New game API response status: ${response.status}`);
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        debugLog("New game created successfully");
                        addMoveToHistory("New game started");

                        return fetch(`${baseUrl}/api/v1/chess/board`, {
                            headers: {
                                'Accept': 'application/json'
                            },
                            credentials: 'same-origin'
                        });
                    })
                    .then(response => {
                        debugLog(`Board API response status: ${response.status}`);
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(boardData => {
                        debugLog(`Board data received with ${boardData.length} pieces`);
                        // Hide game result if visible
                        document.getElementById('game-result').classList.add('hidden');

                        return fetch(`${baseUrl}/api/v1/chess/status`, {
                            headers: {
                                'Accept': 'application/json'
                            },
                            credentials: 'same-origin'
                        });
                    })
                    .then(response => {
                        debugLog(`Status API response status: ${response.status}`);
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(statusData => {
                        debugLog(`Status data received: ${JSON.stringify(statusData)}`);
                        newGameBtn.classList.remove('loading');
                        newGameBtn.textContent = "New Game";

                        // Update status with animation
                        const statusElement = document.getElementById('status');
                        statusElement.classList.add('status-update');
                        statusElement.textContent = `Current Turn: ${statusData.currentPlayer || 'White'}`;
                        setTimeout(() => {
                            statusElement.classList.remove('status-update');
                        }, 500);

                        debugLog("All API calls completed successfully");
                    })
                    .catch(error => {
                        newGameBtn.classList.remove('loading');
                        newGameBtn.textContent = "New Game";

                        // Show error notification
                        const gameResult = document.getElementById('game-result');
                        gameResult.textContent = `Error: ${error.message}`;
                        gameResult.classList.remove('hidden');
                        gameResult.classList.add('error');

                        debugLog(`Error: ${error.message}`);
                        // Try to determine if it's a CORS issue
                        if (error.message.includes('NetworkError') || error.message.includes('Failed to fetch')) {
                            debugLog("This might be a CORS or network issue. Check browser console for more details.");
                        }
                    });
            });

            // Make sure the button is visible and enabled
            newGameBtn.style.display = 'inline-block';
            newGameBtn.disabled = false;
            debugLog("Button click listener attached");
        } else {
            debugLog("New Game button NOT found");
        }
    });

    // Listen for move events from the chess.js script
    document.addEventListener('chess-move', function(e) {
        debugLog("Chess move event received");
        if (e.detail && e.detail.notation) {
            addMoveToHistory(e.detail.notation);

            // If a piece was captured
            if (e.detail.capturedPiece) {
                addCapturedPiece(e.detail.capturedPiece, e.detail.capturedColor);
            }
        }
    });
</script>
<script src="/js/chess.js"></script>
</body>
</html>
```
